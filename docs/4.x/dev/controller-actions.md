# Controller Actions

Controllers are Craft’s way of talking to the outside world. Pretty much everything you do with Craft is part of a request that involves a [controller action](guide:structure-controllers)—from updating settings to rendering an entry.

Most controllers and actions are carefully locked down with [permissions](../user-management.md#permissions) to prevent malicious activity, but a select few are necessarily available to logged-in users and “guests” (to support features like [public registration](../user-management.md#public-registration) or [cart management](/docs/commerce/4.x/orders-carts.md)).

To get a sense for the kind of things you can do, jump to the [available actions](#available-actions).

## Making Requests

An “action request” is one that explicitly declares the controller and action to use, via an `action` query or body param. Craft also supports routing to specific actions using a path defined by the <config4:actionTrigger> setting, or [aliased in `routes.php`](../routing.md#advanced-routing-with-url-rules).

::: tip
This `action` parameter is different from the `<form action="...">` attribute:

- The `action` _param_ should be used within a URL query string (`?action=...`) for `GET` requests, or in the body of a `POST` request.
- The _form attribute_ should only be used when you want a form to submit to a different path than the user is already on. This attribute has no effect if a redirect is issued in response to the request. When an `action` param is _not_ present in the request, you can use an “action path” like `action="/actions/users/login"`.
:::

### HTTP Verbs

Each action usually responds to one [HTTP method](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods). Using an unsupported method will throw a <yii2:yii\web\BadRequestHttpException>, and show your [error template](../routing.md#error-templates) with a 400 `statusCode`.

#### `POST`

All `POST` requests are made through forms or [AJAX](#ajax), and require an `action` parameter and CSRF token.

```twig
{# Let your users request a password reset: #}
<form method="post" accept-charset="UTF-8">
    {{ csrfInput() }}
    {{ actionInput('users/send-password-reset-email') }}

    <label for="loginName">Username or email</label>
    <input type="text" name="loginName" id="loginName">

    <button>Request</button>
</form>
```

Some `POST` requests will write “flashes” into the session to communicate successes and failures. Flashes can be output in your templates:

```twig
{# Retrieve + clear all flashes: #}
{% set flashes = craft.app.session.getAllFlashes(true) %}

{% if flashes | length %}
    {% for type, flash in flashes %}
        <p class="{{ type }}">{{ flash }}</p>
    {% endfor %}
{% endif %}
```

::: tip
Flashes are _not_ set when using [AJAX](#ajax). Look for errors in the response!
:::

#### `GET`

`GET` requests are made by accessing an action URL by way of a regular anchor tag, a form submission, or AJAX. `GET` action requests are much less common than `POST`, as the bulk of read-only request routing is handled for you, out of the box.

::: code
```twig Anchor/Link
{# Output a “log out” link: #}
<a href="{{ actionUrl('users/logout') }}">Log Out</a>
```
```twig Form
{# Pass any element to this (as a Twig partial) to get a CP edit link: #}
<form>
    {{ actionInput('elements/redirect') }}
    {{ hiddenInput('elementId', object.id) }}

    <button>Edit</button>
</form>
```
```js AJAX
// Get info about the current session (guests) and user (if logged in):
fetch('/actions/users/session-info', {
    headers: {
        'Accept': 'application/json',
    },
})
    .then(r => r.json())
    .then(console.log);
// -> { isGuest: true, timeout: 0, csrfTokenValue: '...' }
```
:::

::: tip
You may notice that the `actionUrl()` function generates URLs with `index.php` visible, despite your <config4:omitScriptNameInUrls> setting. This is intended, as it guarantees compatibility with all environments, regardless of configuration.

If you need a cleaner URL, consider setting up a custom [route](../routing.md#advanced-routing-with-url-rules).
:::

### CSRF

Craft has built-in [Cross-Site Request Forgery](https://owasp.org/www-community/attacks/csrf) mitigation, and therefore requires a valid session and token any time data is submitted via a controller action.

For requests generated by an HTML `<form>`, use the `csrfInput()` [Twig helper](#form-helpers):

```twig
<form method="POST">
    {{ csrfInput() }}
    {{ actionInput('entries/save-entry) }}

    {# ... #}
</form>
```

The process is slightly more complicated for [AJAX](#ajax) requests, but can be abstracted in a manner appropriate for your project.

### Form Helpers

Craft has a number of built-in Twig functions to make dealing with forms and input easier.

Function | Notes
-------- | -----
[actionInput()](./functions.md#actioninput) | Generate a hidden HTML `<input>` element for controlling which action a `<form>` should route to.
[actionUrl()](./functions.md#actionurl) | Generate an absolute URL to the specified action, with any extra params. <badge vertical="baseline" type="verb">GET</badge> only.
[csrfInput()](./functions.md#csrfinput) | Generate a hidden HTML `<input>` required for CSRF protection.
[failMessageInput()](./functions.md#failmessageinput) | Override error-condition flash messages. <badge vertical="baseline" type="verb">POST</badge> only.
[hiddenInput()](./functions.md#hiddeninput) | Lower-level helper for generating hidden HTML inputs.
[input()](./functions.md#input) | Even finer-grained control over HTML `<input>` element creation.
[redirectInput()](./functions.md#redirectinput) | Generates a hidden HTML `<input>` element to control redirection after successful requests. <badge vertical="baseline" type="verb">POST</badge> only.
[successMessageInput()](./functions.md#successmessageinput) | Override success-condition flash messages. <badge vertical="baseline" type="verb">POST</badge> only.

### AJAX

In order to respond appropriately, Craft requires that AJAX requests are identified as such. Some tools (like jQuery) need no configuration; others (like the native [`fetch()` API](https://developer.mozilla.org/en-US/docs/Web/API/fetch)) will need to be configured explicitly:

Header | Notes
------ | -----
`Accept` | Set to `application/json` to receive a JSON response (when available).
`X-Requested-With` | Set to `XMLHttpRequest` if your templates rely on `craft.app.request.isAjax`.
`X-CSRF-Token` | Send a valid CSRF token (for POST requests) if none is provided in the request body under the key determined by <config4:csrfTokenName>.
`Content-Type` | Set to `application/json` if the [request’s body](guide:runtime-requests#request-parameters) is a serialized JSON payload (as opposed to `FormData`).

#### 
A CSRF token is still required for AJAX requests using the `POST` method. You can ensure a session is started (for guests) by preflighting a request to the `users/session-info` action:

```js
// Helper for fetching a CSRF token:
const getSessionInfo = function() {
    return fetch('/actions/users/session-info', {
        headers: {
            'Accept': 'application/json',
        },
    })
        .then(r => r.json());
};

// Session info is passed to the chained handler:
getSessionInfo()
    .then(session => {
        const params = new FormData();

        // Read the User’s ID from the session data (assuming they’re logged in):
        params.append('userId', session.id);
        params.append('fullName', 'Tony Tiger');

        return fetch('/actions/users/save-user', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'X-CSRF-Token': session.csrfTokenValue,
                'X-Requested-With': 'XMLHttpRequest',
                // If `params` is a JSON-encoded payload,
                // also set `Content-Type`!
            },
            body: params,
        });
    })
    .then(r => r.json())
    .then(console.log);
```

This example assumes you have no preexisting HTML from the server (as though it was part of a [headless](config4:headlessMode) application). If you are working on a hybrid front-end (and sprinkling interactivity into primarily server-rendered pages), you could eliminate the first request by stashing the User’s ID and CSRF token in the document’s `<head>` (or on a relevant element) and reading it with Javascript:

```twig
<button
    id="update-name"
    data-user-id="{{ currentUser.id }}"
    data-csrf-token-value="{{ craft.app.request.getCsrfToken() }}"
    data-csrf-token-name="{{ craft.app.config.general.csrfTokenName }}">Edit Name</button>

<script>
    const $button = document.getElementById('update-name');

    $button.addEventListener('click', function(e) {
        const params = new FormData();

        params.append('userId', $button.dataset.userId);
        params.append($button.dataset.csrfTokenName, $button.dataset.csrfTokenValue);
        params.append('fullName', prompt('New name:'));

        fetch('/actions/users/save-user', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: params,
        });
    });
</script>
```


## Available Actions

This is not a comprehensive list! We have selected a few actions to illustrate fundamentals that many projects can benefit from—the rest of Craft’s [HTTP API](https://github.com/craftcms/cms/tree/main/src/controllers) will require some independent exploration!

Action | Description
------ | -----------
<badge vertical="baseline" type="verb">POST</badge> [entries/save-entry](#post-entries-save-entry) | Creates or updates an entry.
<badge vertical="baseline" type="verb">POST</badge> [users/login](#post-users-login) | Logs a user in.
<badge vertical="baseline" type="verb">POST</badge> [users/save-user](#post-users-save-user) | Creates or updates a user account.
<badge vertical="baseline" type="verb">POST</badge> [users/send-password-reset-email](#post-users-send-password-reset-email) | Sends a password reset email.
<badge vertical="baseline" type="verb">POST</badge> [users/set-password](#post-users-set-password) | Sets a new password on a user account.
<badge vertical="baseline" type="verb">POST</badge> [users/save-address](#post-users-save-address) | Create or update an [Address](../addresses.md) element.
<badge vertical="baseline" type="verb">POST</badge> [users/delete-address](#post-users-delete-address) | Delete an Address element.
<badge vertical="baseline" type="verb">GET</badge> [users/session-info](#get-users-session-info) | Retrieve information about the current session.
<badge vertical="baseline" type="verb">GET</badge> [app/health-check](#get-app-health-check) | Verify your app is accessible.
<badge vertical="baseline" type="verb">GET</badge> [redirect](#get-redirect) | Redirects the user to another (validated) URL.


### <badge vertical="baseline" type="verb">POST</badge> `entries/save-entry`

Saves an entry.

This can be used to save a new or existing entry, determined by the `sourceId` param.

::: tip
See the [Entry Form](https://craftcms.com/knowledge-base/entry-form) guide for an example of working with this action.
:::

::: warning
Note that _all_ custom fields can updated by users. For this reason, you should not assume that custom fields are protected from modification simply because they are not included in the form. 
:::

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`authorId` | The ID of the user account that should be set as the entry author. (Defaults to the entry’s current author, or the logged-in user.)
`enabledForSite` | Whether the entry should be enabled for the current site (`1`/`0`), or an array of site IDs that the entry should be enabled for. (Defaults to the `enabled` param.)
`enabled` | Whether the entry should be enabled (`1`/`0`). (Defaults to enabled.)
`entryId` | Fallback if `sourceId` isn’t passed, for backwards compatibility.
`entryVariable` | The hashed name of the variable that should reference the entry, if a validation error occurs. (Defaults to `entry`.)
`expiryDate` | The expiry date for the entry. (Defaults to the current expiry date, or `null`.)
`failMessage` | The hashed flash notice that should be displayed, if the entry is not saved successfully. (Only used for `text/html` requests.)
`fieldsLocation` | The name of the param that holds any custom field values. (Defaults to `fields`.)
`fields[]` | An array of new custom field values, indexed by field handles. (The param name can be customized via `fieldsLocation`.) Only fields that are included in this array will be updated.
`parentId` | The ID of the parent entry, if it belongs to a structure section.
`postDate` | The post date for the entry. (Defaults to the current post date, or the current time.)
`redirect` | The hashed URL to redirect the browser to, if the entry is saved successfully. (The requested URI will be used by default.)
`revisionNotes` | Notes that should be stored on the new entry revision.
`siteId` | The ID of the site to save the entry in.
`slug` | The entry slug. (Defaults to the current slug, or an auto-generated slug.)
`sourceId` | The ID of the entry to save, if updating an existing entry.
`successMessage` | The hashed flash notice that should be displayed, if the entry is saved successfully. (Only used for `text/html` requests.)
`title` | The entry title. (Defaults to the current entry title.)
`typeId` | The entry type ID to save the entry as. (Defaults to the current entry type.)

#### Response

The action’s output depends on whether the entry saved successfully and the request included an `Accept: application/json` header.

<span class="croker-table">

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response per the hashed `redirect` param. | 200 JSON response with `success`, `id`, `title`, `slug`, `authorUsername`, `dateCreated`, `dateUpdated`, and `postDate` keys.
<x-mark/> | None; the request will be routed per the URI. An `entry` variable will be passed to the resulting template. The template can access validation errors via [getErrors()](yii2:yii\base\Model::getErrors()), [getFirstError()](yii2:yii\base\Model::getFirstError()), etc. | 400 JSON response with an `errors` key set to the result of [getErrors()](yii2:yii\base\Model::getErrors()).

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/login`

Logs a user in.

::: tip
See the [Front-End User Accounts](https://craftcms.com/knowledge-base/front-end-user-accounts#login-form) guide for an example of working with this action.
:::

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`failMessage` | The hashed flash notice that should be displayed, if the user is not logged in successfully. (Only used for `text/html` requests.)
`loginName` | The username or email of the user to login.
`password` | The user’s password.
`rememberMe` | Whether to keep the user logged-in for an extended period of time per the <config4:rememberedUserSessionDuration> config setting (`1`/`0`).

#### Response

The output of the action depends on whether the login was successful and the request included an `Accept: application/json` header.

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response per the hashed `redirect` param, or the user session’s return URL. | 200 JSON response with `returnUrl` and `csrfTokenValue` keys.
<x-mark/> | None; the request will be routed per the URI. `loginName`, `rememberMe`, `errorCode`, and `errorMessage` variables will be passed to the resulting template. | 400 JSON response with `errorCode` and `message` keys.

</span>

### <badge vertical="baseline" type="verb">POST</badge> `users/save-user`

Saves a user account.

This can be used to register a new user or update an existing one, determined by the `userId` param.

::: tip
See the [Front-End User Accounts](https://craftcms.com/knowledge-base/front-end-user-accounts#registration-form) guide for an example of working with this action.
:::

::: warning
Note that _all_ custom fields can updated by users. For this reason, you should not assume that custom fields are protected from modification simply because they are not included in the form. 
:::

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`admin` | Whether the user should be saved as an admin (`1`/`0`). Only checked if the logged-in user is an admin.
`currentPassword` | The user’s current password, which is required if `email` or `newPassword` are sent.
`email` | The user’s email address. (Only checked if registering a new user, updating the logged-in user, or the logged-in user is allowed to administrate users.)
`failMessage` | The hashed flash notice that should be displayed, if the user account is not saved successfully. (Only used for `text/html` requests.)
`fieldsLocation` | The name of the param that holds any custom field values. (Defaults to `fields`.)
`fields[]` | An array of new custom field values, indexed by field handles. (The param name can be customized via `fieldsLocation`.) Only fields that are included in this array will be updated.
`firstName` | The user’s first name.
`lastName` | The user’s last name.
`newPassword` | The user’s new password, if updating the logged-in user’s account. (If registering a new user, send `password`.)
`passwordResetRequired` | Whether the user must reset their password before logging in again (`1`/`0`). Only checked if the logged-in user is an admin.
`password` | The user’s password, if registering a new user. (If updating an existing user, send `newPassword`.)
`photo` | An uploaded user photo.
`redirect` | The hashed URL to redirect the browser to, if the user account is saved successfully. (The requested URI will typically be used by default.)
`sendVerificationEmail` | Whether a verification email should be sent before accepting the new `email` (`1`/`0`). (Only checked if email verification is enabled, and the logged-in user is allowed to opt out of sending it.)
`successMessage` | The hashed flash notice that should be displayed, if the user account is saved successfully. (Only used for `text/html` requests.)
`userId` | The ID of the user to save, if updating an existing user.
`userVariable` | The hashed name of the variable that should reference the user, if a validation error occurs. (Defaults to `user`.)
`username` | The user’s username. (Only checked if the <config4:useEmailAsUsername> config setting is disabled.)

#### Response

The output depends on whether the user save action was successful and the request included an `Accept: application/json` header.

<span class="croker-table">

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response per the hashed `redirect` param, or the <config4:activateAccountSuccessPath> config setting if email verification is not required. | 200 JSON response with `id` and `csrfTokenValue` keys.
<x-mark/> | None; the request will be routed per the URI. A `user` variable will be passed to the resulting template. The template can access validation errors via [getErrors()](yii2:yii\base\Model::getErrors()), [getFirstError()](yii2:yii\base\Model::getFirstError()), etc. | 400 JSON response with an `errors` key.

</span>

### <badge vertical="baseline" type="verb">POST</badge> `users/send-password-reset-email`

Sends a password reset email.

::: tip
See the [Front-End User Accounts](https://craftcms.com/knowledge-base/front-end-user-accounts#reset-password-forms) guide for an example of working with this action.
:::

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`loginName` | The username or email of the user to send a password reset email for.
`successMessage` | The hashed flash notice that should be displayed, if the email is sent successfully. (Only used for `text/html` requests.)
`userId` | The ID of the user to send a password reset email for. (Only checked if the logged-in user has permission to edit other users.)

#### Response

The output of the action depends on whether the reset password email was sent successfully, and whether the request included an `Accept: application/json` header.

<span class="croker-table">

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response per the hashed `redirect` param. | 200 JSON response.
<x-mark/> | None; the request will be routed per the URI. `errors` and `loginName` variables will be passed to the resulting template. | 400 JSON response with an `error` key.

</span>

### <badge vertical="baseline" type="verb">POST</badge> `users/set-password`

Sets a new password on a user account.

If the user is pending, their account will be activated as well.

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`code` | The user’s verification code.
`failMessage` | The hashed flash notice that should be displayed, if the password is not set successfully. (Only used for `text/html` requests.)
`id` | The user’s UUID.
`newPassword` | The user’s new password.

#### Response

The output of the action depends on whether the password was updated successfully and the request included an `Accept: application/json` header.

<span class="croker-table">

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response depending on the <config4:autoLoginAfterAccountActivation> and <config4:setPasswordSuccessPath> config settings, and whether the user has access to the control panel. | 200 JSON response with a `csrfTokenValue` key.
<x-mark/> | None; the request will be routed per the URI. `errors` , `code`, `id`, and `newUser` variables will be passed to the resulting template. | 400 JSON response.

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/save-address`

Saves or updates an [Address](../addresses.md) element against the current User’s account.

#### Supported Params

The following params can be sent with the request:

Param | Description
----- | -----------
`addressId` | An existing Address’s ID can be sent to update it, as long as it’s owned by the current User.

#### Response

The output of the action depends on whether the password was updated successfully and the request included an `Accept: application/json` header.

<span class="croker-table">

State   | Standard | AJAX
------- | -------- | ----
<check-mark/> | 302 redirect response depending on the <config4:autoLoginAfterAccountActivation> and <config4:setPasswordSuccessPath> config settings, and whether the user has access to the control panel. | 200 JSON response with a `csrfTokenValue` key.
<x-mark/> | None; the request will be routed per the URI. `errors` , `code`, `id`, and `newUser` variables will be passed to the resulting template. | 400 JSON response.

</span>


### <badge vertical="baseline" type="verb">POST</badge> `users/delete-address`

Deletes an address owned by the current User.

### <badge vertical="baseline" type="verb">GET</badge> `users/session-info`

Retrieves information about the current session.
